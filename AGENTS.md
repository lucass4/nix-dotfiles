# Agent Guide

- **Project overview:** Nix flake for macOS dotfiles using nix-darwin + Home Manager. Hosts are defined in `flake.nix` and map to systems `x86_64-darwin` / `aarch64-darwin`. User is `lucas` with home at `/Users/lucas`.
- **Layout:** `modules/darwin` (system prefs, Homebrew taps/casks/brews, core nix settings). `modules/home-manager` (imports + session vars) and `modules/home-manager/modules` for app-specific configs: `zsh.nix`, `git.nix`, `helix.nix`, `tmux.nix`, `wezterm.nix`, `yazi.nix`, `languages/*.nix` for language toolchains.
- **Build/apply:** `make build` or `make switchx` â†’ `darwin-rebuild switch --flake .#$(hostname -s)` (requires sudo). `make update` also runs `nix flake update` and Homebrew upgrades. `make check-updates` runs `nix flake check` and darwin build. Use `nix flake check` before pushing.
- **Dev tools:** Default shell `zsh` with oh-my-zsh plugins (`sudo`, `vim-interaction`, `fzf`, `vi-mode`, `zoxide`) and aliases (`vim/vi -> hx`, git shortcuts, eza/rg/fd, trash). Terminal stack: WezTerm launching tmux session `main`; tmux key prefix `C-a`, vi key mode, plugins (resurrect, tmux-fzf, etc.). Editor: Helix with Catppuccin Mocha theme, language servers/formatters for Rust, Go, Python, JS/TS/HTML/CSS, Nix, Bash, Terraform, Docker, YAML. File manager: Yazi enabled with zsh integration.
- **Git/GitHub:** Global git config in `modules/home-manager/modules/git.nix`: delta as pager/difftool (`git diff` is side-by-side with line numbers), patience diff algorithm, signed commits/tags using GPG key `56AE81F1E53DC9DC`, SSH GitHub URLs (`git@github.com:`) with `http.sslVerify = true`. GH CLI set to SSH protocol, editor `hx`, pager delta.
- **Homebrew (darwin):** Managed in `modules/darwin/brew.nix`. Taps include k8s/cloud/security tools. Casks include Alacritty, Raycast, VS Code, Arc, 1Password, Discord, Spotify, GPG Suite, etc. Brews include dev deps (go, node, openjdk, neovim, pre-commit, just, tree-sitter, lua stack), infra tools (kubectl/kustomize/eksctl/vcluster/argocd), and utilities (trivy, granted, copier, gemini-cli, skopeo).
- **Code/style conventions:** Keep Nix expressions consistent with existing modules; prefer small, composable modules over monoliths. Use `pkgs.<pkg>` and mirror patterns in sibling language modules. Avoid hardcoding paths outside `$HOME` unless already used (e.g., `/opt/homebrew/bin` in darwin module). Default editor/visual tools are `hx`, WezTerm + tmux.
- **Testing:** For module edits run `nix flake check`. For config activation tests run `make build` (or `darwin-rebuild switch --flake .#$(hostname -s)`). For Homebrew changes ensure taps/casks/brews resolve. Helix keybinds use external CLIs (`scooter`, `lazygit`, `yazi`), so keep them installed or update bindings.
- **Security considerations:** Never commit secrets. Git signing is on by default; do not disable unless requested. GitHub uses SSH; keep `http.sslVerify = true`. Respect `system.primaryUser = "lucas"` and `system.stateVersion = 4`. Beware Homebrew installs that may prompt for sudo when activated.
- **PR/commit tips:** Describe scope by module (e.g., `hm/helix: ...`, `darwin/brew: ...`). Avoid touching `flake.lock` unless intentionally updating inputs. Keep changes minimal and follow existing patterns. Mention if a rebuild is required (almost always). In monorepo subdirs add nested `AGENTS.md` if specialized.
